<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Improving AI Assistant</title>
    <style>
        body { font-family: 'Inter', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f4f8; color: #333; }
        h1 { color: #007bff; text-align: center; }
        #app-container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 20px; }
        #chat-container { height: 400px; overflow-y: auto; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .message { margin: 10px 0; padding: 12px; border-radius: 8px; max-width: 80%; word-wrap: break-word; }
        .user { background: #007bff; color: white; text-align: right; margin-left: auto; border-bottom-right-radius: 2px; }
        .ai { background: #e9ecef; color: black; text-align: left; border-bottom-left-radius: 2px; }
        .system-info { background: #d1ecf1; color: #0c5460; text-align: center; font-style: italic; font-size: 0.9em; }
        #input-form { display: flex; gap: 10px; }
        #message { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #0056b3; }
        #status { font-size: 0.9em; color: #666; margin-top: 15px; display: flex; justify-content: space-between; align-items: center;}

        /* Patch Proposal Modal/Card */
        #patch-card { 
            background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; 
            padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: none; /* Hidden by default */
        }
        #patch-card button { 
            padding: 8px 15px; margin-left: 10px; font-size: 0.9em;
            background: #28a745; 
        }
        #patch-card .reject-btn { background: #dc3545; }

    </style>
</head>
<body>
    <div id="app-container">
        <h1>ðŸ¤– Self-Improving AI Chat</h1>
        <p style="text-align: center; font-size: 0.9em; color: #666;">
            Commands: Type "reflect" to propose a self-improvement, "advance" to jump to next phase.
        </p>

        <!-- Patch Proposal Card -->
        <div id="patch-card">
            <strong>ðŸš€ Self-Improvement Proposal Ready!</strong>
            <p id="patch-query" style="margin: 5px 0;"></p>
            <small>Target: <span id="patch-target"></span> | Tests: <span id="patch-tests-count"></span></small>
            <div style="margin-top: 10px; text-align: right;">
                <button class="reject-btn" onclick="sendDecision('reject')">Reject</button>
                <button onclick="sendDecision('approve')">Approve Patch</button>
            </div>
        </div>

        <div id="chat-container"></div>
        <form id="input-form">
            <input type="text" id="message" placeholder="Enter your query..." autocomplete="off">
            <button type="submit">Send</button>
        </form>
        <div id="status">
            <span>Phase: <strong id="phase-num">Loading...</strong></span>
            <span id="phase-detail"></span>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message');
        const form = document.getElementById('input-form');
        const phaseNumSpan = document.getElementById('phase-num');
        const phaseDetailSpan = document.getElementById('phase-detail');
        const patchCard = document.getElementById('patch-card');
        const patchQueryEl = document.getElementById('patch-query');
        const patchTargetEl = document.getElementById('patch-target');
        const patchTestsCountEl = document.getElementById('patch-tests-count');

        let isLoading = false; 

        function addMessage(content, isUser, isSystemInfo = false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : (isSystemInfo ? 'system-info' : 'ai')}`;
            div.innerHTML = content.replace(/\n/g, '<br>'); 
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function fetchPhaseStatus() {
            try {
                const res = await fetch('/phase');
                const data = await res.json();
                phaseNumSpan.textContent = data.phase;
                phaseDetailSpan.textContent = data.detail;
            } catch (err) {
                console.error('Failed to fetch phase status:', err);
            }
        }

        async function fetchPatchProposal() {
            try {
                const res = await fetch('/patch/proposal');
                const data = await res.json();

                if (data.status === 'pending') {
                    patchQueryEl.textContent = data.query;
                    patchTargetEl.textContent = data.target;
                    patchTestsCountEl.textContent = data.tests_count;
                    patchCard.style.display = 'block';
                } else {
                    patchCard.style.display = 'none';
                }
            } catch (err) {
                console.warn('Patch proposal poll failed:', err);
            }
        }

        async function sendDecision(decision) {
            patchCard.style.display = 'none'; 
            addMessage(`User decision: ${decision.toUpperCase()}. Processing patch...`, true);

            try {
                const res = await fetch('/patch/decide', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({decision: decision})
                });
                const data = await res.json();
                addMessage(data.message, false, true); // System info style
                fetchPhaseStatus(); 
            } catch (err) {
                addMessage('Decision Error: ' + err.message, false);
            }
        }

        window.sendDecision = sendDecision; 

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isLoading) return;

            const userInput = messageInput.value.trim();
            if (!userInput) return;

            // Special handling for commands to provide immediate feedback
            const isCommand = ['reflect', 'advance'].includes(userInput.toLowerCase());

            // 1. Add user message immediately
            addMessage(userInput, true);
            messageInput.value = '';
            isLoading = true;

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: userInput})
                });
                const data = await res.json();

                // 2. Clear history and re-render from server response
                chatContainer.innerHTML = '';
                data.history.forEach(h => {
                    addMessage(h.user, true);
                    // Check if AI response is a system command confirmation
                    if (h.user.toLowerCase() === 'reflect' && h.ai.startsWith("Reflection process initiated")) {
                         addMessage(h.ai, false, true); // System info style
                    } else {
                         addMessage(h.ai, false);
                    }
                });

            } catch (err) {
                addMessage('Error: ' + err.message, false);
            } finally {
                isLoading = false;
            }
        });

        // Poll for system alerts
        setInterval(async () => {
            try {
                const res = await fetch('/alerts');
                const data = await res.json();
                if (data.alerts && data.alerts.length > 0) {
                    // Display alerts using the system info style
                    data.alerts.forEach(alert => addMessage(`[System Alert]: ${alert}`, false, true)); 
                }
            } catch (err) {
                console.warn('Alert poll failed:', err);
            }
        }, 3000); 

        // Poll for patch proposals
        setInterval(fetchPatchProposal, 5000); 

        // Initial setup
        fetchPhaseStatus();
        messageInput.focus();
    </script>
</body>
</html>

